// Arquivo: main.js
import * as auth from './auth.js';
import * as ui from './ui.js';
import * as api from './api.js';
import * as utils from './utils.js';
import { supabase } from './supabaseClient.js';

let currentUserProfile=null,technicalData=null,clients=[],currentClient=null;function main(){setupEventListeners(),utils.atualizarMascaraDocumento()}function setupEventListeners(){document.getElementById("loginBtn").addEventListener("click",handleLogin),document.getElementById("logoutBtn").addEventListener("click",handleLogout),document.getElementById("registerBtn").addEventListener("click",()=>ui.openModal("registerModalOverlay")),document.getElementById("registerForm").addEventListener("submit",handleRegister),document.getElementById("forgotPasswordLink").addEventListener("click",e=>{e.preventDefault(),ui.openModal("forgotPasswordModalOverlay")}),document.getElementById("forgotPasswordForm").addEventListener("submit",handleForgotPassword),document.getElementById("resetPasswordForm").addEventListener("submit",handleResetPassword),document.querySelectorAll(".close-modal-btn").forEach(e=>{e.addEventListener("click",t=>ui.closeModal(t.target.dataset.modalId))}),document.getElementById("saveBtn").addEventListener("click",handleSaveProject),document.getElementById("loadBtn").addEventListener("click",handleLoadProject),document.getElementById("deleteBtn").addEventListener("click",handleDeleteProject),document.getElementById("newBtn").addEventListener("click",handleNewProject),document.getElementById("searchInput").addEventListener("input",e=>handleSearch(e.target.value)),document.getElementById("clientManagementBtn").addEventListener("click",handleShowClientManagement),document.getElementById("clientForm").addEventListener("submit",handleSaveClient),document.getElementById("newClientBtn").addEventListener("click",handleNewClient),document.getElementById("deleteClientBtn").addEventListener("click",handleDeleteClient),document.getElementById("clientList").addEventListener("click",handleLoadClient),document.getElementById("clientSearchInput").addEventListener("input",e=>handleSearchClients(e.target.value)),document.getElementById("clientDocumentType").addEventListener("change",ui.toggleLegalRepSection),document.getElementById("clientSearch").addEventListener("blur",handleLinkClientToProject),document.getElementById("addCircuitBtn").addEventListener("click",ui.addCircuit),document.getElementById("circuits-container").addEventListener("click",e=>{e.target.classList.contains("remove-btn")&&ui.removeCircuit(e.target.dataset.circuitId)}),document.getElementById("calculateBtn").addEventListener("click",handleCalculate),document.getElementById("pdfBtn").addEventListener("click",handleGeneratePdf),document.getElementById("regCpf").addEventListener("input",utils.mascaraCPF),document.getElementById("regTelefone").addEventListener("input",utils.mascaraCelular),document.getElementById("editCpf").addEventListener("input",utils.mascaraCPF),document.getElementById("editTelefone").addEventListener("input",utils.mascaraCelular),document.getElementById("tipoDocumento").addEventListener("change",utils.atualizarMascaraDocumento),document.getElementById("documento").addEventListener("input",utils.aplicarMascara),document.getElementById("telefone").addEventListener("input",utils.mascaraTelefone),document.getElementById("celular").addEventListener("input",utils.mascaraCelular),document.getElementById("clientPhone").addEventListener("input",utils.mascaraTelefone),document.getElementById("clientMobile").addEventListener("input",utils.mascaraCelular),document.getElementById("legalRepCpf").addEventListener("input",utils.mascaraCPF),document.getElementById("legalRepPhone").addEventListener("input",utils.mascaraTelefone),document.getElementById("legalRepMobile").addEventListener("input",utils.mascaraCelular),document.getElementById("clientDocumentNumber").addEventListener("input",e=>{let t=document.getElementById("clientDocumentType").value;utils.aplicarMascara(e,t)}),document.getElementById("adminPanelBtn").addEventListener("click",showAdminPanel),document.getElementById("manageProjectsBtn").addEventListener("click",showManageProjectsPanel),document.getElementById("adminUserList").addEventListener("click",handleAdminUserActions),document.getElementById("editUserForm").addEventListener("submit",handleUpdateUser),document.getElementById("adminProjectsTableBody").addEventListener("click",handleAdminProjectActions),document.getElementById("saveUserPermissionsBtn").addEventListener("click",handleUpdatePermissions)}async function handleLogin(){let e=document.getElementById("emailLogin").value,t=document.getElementById("password").value,n=await auth.signInUser(e,t);n&&n.is_approved?(currentUserProfile=n,ui.showAppView(currentUserProfile),await loadInitialData()):n&&!n.is_approved&&(alert("Seu cadastro ainda não foi aprovado por um administrador."),await auth.signOutUser())}async function handleLogout(){currentUserProfile=null,technicalData=null,clients=[],currentClient=null,await auth.signOutUser(),ui.showLoginView()}supabase.auth.onAuthStateChange(async(e,t)=>{if("INITIAL_SESSION"===e&&t){let e=await auth.getSession();e&&e.is_approved&&(currentUserProfile=e,ui.showAppView(currentUserProfile),await loadInitialData())}else"SIGNED_OUT"===e?(currentUserProfile=null,technicalData=null,ui.showLoginView()):"PASSWORD_RECOVERY"===e&&ui.showResetPasswordView()});async function loadInitialData(){technicalData=await api.fetchTechnicalData(),await handleSearch()}async function handleShowClientManagement(){ui.openModal("clientManagementModalOverlay"),handleNewClient(),await handleSearchClients()}async function handleSearchClients(e=""){clients=await api.fetchClients(e,currentUserProfile),ui.populateClientList(clients,currentClient)}function handleNewClient(){currentClient=null,ui.resetClientForm(),ui.populateClientList(clients,null)}async function handleLoadClient(e){let t=e.target.closest("li");if(t){let e=t.dataset.clientId;if(currentClient=clients.find(t=>t.id==e),currentClient){ui.populateClientList(clients,currentClient),ui.populateClientForm(currentClient);let t=await api.fetchProjects(null,currentUserProfile),n=t.filter(t=>t.client_id===currentClient.id);if(ui.populateClientProjectsList(n),currentUserProfile.is_admin){let e=await api.fetchAllUsers(),t=await api.getClientUserPermissions(currentClient.id);ui.populateUserPermissions(e,t)}}}}async function handleSaveClient(e){e.preventDefault();let t=document.getElementById("currentClientId").value,n=document.getElementById("clientName").value,l=document.getElementById("clientDocumentType").value,i=document.getElementById("clientDocumentNumber").value,o=document.getElementById("clientAddress").value,a=document.getElementById("clientPhone").value,d=document.getElementById("clientMobile").value,c=document.getElementById("clientEmail").value,s=document.getElementById("clientBillingEmail").value,r={name:n,document_type:l,document_number:i,address:o,phone:a,mobile_phone:d,email:c,billing_email:s};"CNPJ"===l?(r.legal_rep_name=document.getElementById("legalRepName").value,r.legal_rep_cpf=document.getElementById("legalRepCpf").value,r.legal_rep_phone=document.getElementById("legalRepPhone").value,r.legal_rep_mobile=document.getElementById("legalRepMobile").value,r.legal_rep_email=document.getElementById("legalRepEmail").value):(r.legal_rep_name=null,r.legal_rep_cpf=null,r.legal_rep_phone=null,r.legal_rep_mobile=null,r.legal_rep_email=null);let{data:m,error:u}=await api.saveClient(r,t);u?alert("Erro ao salvar cliente: "+u.message):(alert("Cliente salvo com sucesso!"),handleNewClient(),await handleSearchClients())}async function handleDeleteClient(){let e=document.getElementById("currentClientId").value;if(!e||!currentClient)return void alert("Nenhum cliente selecionado para excluir.");if(confirm(`Tem certeza que deseja excluir o cliente "${currentClient.name}"? As obras vinculadas não serão excluídas, mas perderão o vínculo.`)){let{error:t}=await api.deleteClient(e);t?alert("Erro ao excluir cliente: "+t.message):(alert("Cliente excluído com sucesso."),handleNewClient(),await handleSearchClients())}}async function handleUpdatePermissions(){if(!currentUserProfile.is_admin||!currentClient)return;let e=[];document.querySelectorAll('#userAccessList input[type="checkbox"]:checked').forEach(t=>{e.push(t.value)});let{error:t}=await api.updateClientUserPermissions(currentClient.id,e);t?alert("Erro ao salvar permissões: "+t.message):alert("Permissões atualizadas com sucesso!")}async function handleLinkClientToProject(e){let t=e.target.value.trim();if(!t)return void ui.clearProjectClientInfo();let n=await api.fetchClients(t,currentUserProfile);1===n.length?ui.linkClientToProjectForm(n[0]):(ui.clearProjectClientInfo(),t&&alert(n.length>1?"Múltiplos clientes encontrados. Por favor, seja mais específico.":"Nenhum cliente encontrado."))}async function handleSaveProject(){if(!currentUserProfile)return void alert("Você precisa estar logado para salvar um projeto.");let e=document.getElementById("obra").value.trim();if(!e)return void alert("Por favor, insira um 'Nome da Obra' para salvar.");let t=document.getElementById("clientSearch").value.trim(),n=await api.fetchClients("",{is_admin:!0}),l=n.find(e=>e.client_code===t),i={},o={},a=[];document.querySelectorAll("#main-form input, #main-form select").forEach(e=>i[e.id]=e.value),document.querySelectorAll("#tech-form input").forEach(e=>o[e.id]=e.value),document.querySelectorAll(".circuit-block").forEach(e=>{let t={id:e.dataset.id};e.querySelectorAll("input, select").forEach(e=>t[e.id]="checkbox"===e.type?e.checked:e.value),a.push(t)});let d={project_name:e,main_data:i,tech_data:o,circuits_data:a,owner_id:currentUserProfile.id,client_id:l?l.id:null,project_code:document.getElementById("projectCode").value.trim()||null},c=document.getElementById("currentProjectId").value;try{let{data:t,error:n}=await api.saveProject(d,c);if(n)throw n;alert(`Obra "${e}" salva com sucesso!`),document.getElementById("currentProjectId").value=t.id,document.getElementById("projectCode").value=t.project_code,await handleSearch()}catch(e){alert("Erro ao salvar obra: "+e.message)}}async function handleLoadProject(){let e=document.getElementById("savedProjectsSelect").value;if(e){let t=await api.fetchProjectById(e);t&&(ui.populateFormWithProjectData(t),t.client_id?async()=>{let e=await api.fetchClients("",{is_admin:!0}),n=e.find(e=>e.id===t.client_id);n&&ui.linkClientToProjectForm(n)}():ui.clearProjectClientInfo(),alert(`Obra "${t.name}" carregada.`))}}function handleNewProject(){confirm("Deseja limpar todos os campos para iniciar uma nova obra?")&&(ui.resetForm(!0),ui.clearProjectClientInfo())}async function handleDeleteProject(){let e=document.getElementById("savedProjectsSelect").value;if(e){let t=document.getElementById("savedProjectsSelect").options[document.getElementById("savedProjectsSelect").selectedIndex].text;if(confirm(`Tem certeza que deseja excluir a obra "${t}"?`)){let{error:e}=await api.deleteProject(e);e?alert("Erro ao excluir obra: "+e.message):(alert("Obra excluída."),handleNewProject(),await handleSearch())}}}async function handleSearch(e=""){if(currentUserProfile){let t=await api.fetchProjects(e,currentUserProfile);ui.populateProjectList(t)}}function handleCalculate(){let e=utils.calcularTodosCircuitos(technicalData);e&&ui.renderReport(e)}function handleGeneratePdf(){let e=utils.calcularTodosCircuitos(technicalData);e&&ui.generatePdf(e,currentUserProfile)}async function showAdminPanel(){let e=await api.fetchAllUsers();ui.populateUsersPanel(e),ui.openModal("adminPanelOverlay")}async function showManageProjectsPanel(){let e=await api.fetchProjects(null,{is_admin:!0}),t=await api.fetchAllUsers(),n=await api.fetchClients("",{is_admin:!0});ui.populateProjectsPanel_Admin(e,t,n),ui.openModal("manageProjectsPanelOverlay")}async function handleAdminUserActions(e){let t=e.target,n=t.dataset.userId;t.classList.contains("approve-user-btn")?await api.approveUser(n):t.classList.contains("edit-user-btn")?async()=>{let e=await api.fetchAllUsers(),t=e.find(e=>e.id===n);t&&ui.populateEditUserModal(t)}():t.classList.contains("remove-user-btn")&&alert("A remoção completa de usuários (auth) deve ser feita no painel do Supabase. Esta ação não é suportada diretamente via API por segurança.")}async function handleUpdateUser(e){e.preventDefault();let t=document.getElementById("editUserId").value,n=document.getElementById("editNome").value,l=document.getElementById("editCpf").value,i=document.getElementById("editTelefone").value,o=document.getElementById("editCrea").value,a={nome:n,cpf:l,telefone:i,crea:o};let{error:d}=await api.updateUserProfile(t,a);d?alert("Erro ao atualizar usuário: "+d.message):(alert("Usuário atualizado com sucesso!"),ui.closeModal("editUserModalOverlay"),showAdminPanel())}async function handleAdminProjectActions(e){let t=e.target;if(t.classList.contains("transfer-btn")){let n=t.dataset.projectId;if(t.classList.contains("transfer-user-btn")){let e=t.previousElementSibling.value;let{error:l}=await api.transferProjectOwner(n,e);l?alert("Erro ao transferir proprietário da obra: "+l.message):(alert("Proprietário da obra alterado com sucesso!"),showManageProjectsPanel())}if(t.classList.contains("transfer-client-btn")){let e=t.previousElementSibling.value;if(!e)return void alert("Selecione um cliente de destino.");let{error:t}=await api.transferProjectClient(n,e);t?alert("Erro ao transferir obra de cliente: "+t.message):(alert("Obra transferida para o novo cliente!"),showManageProjectsPanel())}}}async function handleRegister(e){e.preventDefault();let t=document.getElementById("regEmail").value,n=document.getElementById("regPassword").value,l=document.getElementById("regNome").value,i=document.getElementById("regCpf").value,o=document.getElementById("regTelefone").value,a=document.getElementById("regCrea").value,d={nome:l,cpf:i,telefone:o,crea:a,email:t};let{error:c}=await auth.signUpUser(t,n,d);c||(alert("Cadastro realizado com sucesso! Aguarde a aprovação de um administrador."),ui.closeModal("registerModalOverlay"),e.target.reset())}async function handleForgotPassword(e){e.preventDefault();let t=document.getElementById("forgotEmail").value;let{error:n}=await auth.sendPasswordResetEmail(t);n?alert("Erro ao enviar e-mail: "+n.message):(alert("Se o e-mail estiver cadastrado, um link de redefinição foi enviado!"),ui.closeModal("forgotPasswordModalOverlay"),e.target.reset())}async function handleResetPassword(e){e.preventDefault();let t=document.getElementById("newPassword").value;if(!t||t.length<6)return void alert("A senha precisa ter no mínimo 6 caracteres.");let{error:n}=await auth.updatePassword(t);n?alert("Erro ao atualizar senha: "+n.message):(alert("Senha atualizada com sucesso! A página será recarregada. Por favor, faça o login com sua nova senha."),window.location.hash="",window.location.reload())}document.addEventListener("DOMContentLoaded",main);